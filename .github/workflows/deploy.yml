name: Deploy Earth Copilot

on:
  # Disabled auto-deploy on push - use manual workflow_dispatch only
  # push:
  #   branches: [main]
  #   paths:
  #     - 'earth-copilot/infra/**'
  #     - 'earth-copilot/container-app/**'
  #     - 'earth-copilot/web-ui/**'
  #     - '.github/workflows/deploy.yml'
  workflow_dispatch:
    inputs:
      force_all:
        description: 'Force deploy all components'
        required: false
        default: false
        type: boolean

permissions:
  contents: read
  id-token: write

# Only resource group and location are fixed - all other resource names are discovered dynamically
env:
  RESOURCE_GROUP: rg-earthcopilot
  LOCATION: eastus2

jobs:
  # Detect which components changed
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      infra: ${{ steps.filter.outputs.infra }}
      backend: ${{ steps.filter.outputs.backend }}
      frontend: ${{ steps.filter.outputs.frontend }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect file changes
        id: filter
        run: |
          # For manual trigger with force_all, deploy everything
          if [ "${{ github.event.inputs.force_all }}" == "true" ]; then
            echo "infra=true" >> $GITHUB_OUTPUT
            echo "backend=true" >> $GITHUB_OUTPUT
            echo "frontend=true" >> $GITHUB_OUTPUT
            echo "ðŸ”„ Force deploy all components"
            exit 0
          fi
          
          # Get changed files
          if [ "${{ github.event_name }}" == "push" ]; then
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD 2>/dev/null || echo "")
          else
            # For manual trigger without force_all, deploy everything
            echo "infra=true" >> $GITHUB_OUTPUT
            echo "backend=true" >> $GITHUB_OUTPUT
            echo "frontend=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "Changed files:"
          echo "$CHANGED_FILES"
          
          # Check each component
          INFRA_CHANGED=false
          BACKEND_CHANGED=false
          FRONTEND_CHANGED=false
          
          if echo "$CHANGED_FILES" | grep -q "^earth-copilot/infra/"; then
            INFRA_CHANGED=true
          fi
          
          if echo "$CHANGED_FILES" | grep -q "^earth-copilot/container-app/"; then
            BACKEND_CHANGED=true
          fi
          
          if echo "$CHANGED_FILES" | grep -q "^earth-copilot/web-ui/"; then
            FRONTEND_CHANGED=true
          fi
          
          # If workflow file changed, deploy all
          if echo "$CHANGED_FILES" | grep -q "^.github/workflows/deploy.yml"; then
            INFRA_CHANGED=true
            BACKEND_CHANGED=true
            FRONTEND_CHANGED=true
          fi
          
          echo "infra=$INFRA_CHANGED" >> $GITHUB_OUTPUT
          echo "backend=$BACKEND_CHANGED" >> $GITHUB_OUTPUT
          echo "frontend=$FRONTEND_CHANGED" >> $GITHUB_OUTPUT
          
          echo ""
          echo "ðŸ“Š Components to deploy:"
          echo "  Infrastructure: $INFRA_CHANGED"
          echo "  Backend: $BACKEND_CHANGED"
          echo "  Frontend: $FRONTEND_CHANGED"

  # Deploy Infrastructure (only if infra files changed)
  deploy-infrastructure:
    name: Deploy Infrastructure
    needs: detect-changes
    if: needs.detect-changes.outputs.infra == 'true'
    runs-on: ubuntu-latest
    environment: dev
    outputs:
      container_registry_name: ${{ steps.discover.outputs.container_registry_name }}
      container_app_name: ${{ steps.discover.outputs.container_app_name }}
      web_app_name: ${{ steps.discover.outputs.web_app_name }}
      container_app_url: ${{ steps.discover.outputs.container_app_url }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy Infrastructure with Bicep
        run: |
          cd earth-copilot
          
          DEPLOYMENT_NAME="earthcopilot-$(date +%Y%m%d-%H%M%S)"
          
          echo "ðŸš€ Deploying Infrastructure..."
          
          az deployment sub create \
            --location "${{ env.LOCATION }}" \
            --template-file infra/main.bicep \
            --parameters environmentName="earthcopilot" \
            --parameters location="${{ env.LOCATION }}" \
            --parameters deployAIFoundry=true \
            --parameters deployAIServices=true \
            --parameters containerImage="" \
            --name "$DEPLOYMENT_NAME" \
            --output none
          
          echo "âœ… Infrastructure deployed"

      - name: Discover Resource Names
        id: discover
        run: |
          echo "ðŸ” Discovering deployed resource names..."
          
          # Discover Container Registry
          ACR_NAME=$(az acr list --resource-group ${{ env.RESOURCE_GROUP }} --query "[0].name" -o tsv)
          echo "container_registry_name=$ACR_NAME" >> $GITHUB_OUTPUT
          echo "  âœ… Container Registry: $ACR_NAME"
          
          # Discover Container App
          CA_NAME=$(az containerapp list --resource-group ${{ env.RESOURCE_GROUP }} --query "[0].name" -o tsv)
          echo "container_app_name=$CA_NAME" >> $GITHUB_OUTPUT
          echo "  âœ… Container App: $CA_NAME"
          
          # Discover Web App
          WA_NAME=$(az webapp list --resource-group ${{ env.RESOURCE_GROUP }} --query "[0].name" -o tsv)
          echo "web_app_name=$WA_NAME" >> $GITHUB_OUTPUT
          echo "  âœ… Web App: $WA_NAME"
          
          # Get Container App URL
          if [ -n "$CA_NAME" ]; then
            CA_URL=$(az containerapp show --name "$CA_NAME" --resource-group ${{ env.RESOURCE_GROUP }} --query "properties.configuration.ingress.fqdn" -o tsv)
            echo "container_app_url=https://$CA_URL" >> $GITHUB_OUTPUT
            echo "  âœ… Container App URL: https://$CA_URL"
          fi

  # Deploy Backend (if backend files changed OR infra deployed)
  deploy-backend:
    name: Deploy Backend
    needs: [detect-changes, deploy-infrastructure]
    if: |
      always() &&
      (needs.detect-changes.outputs.backend == 'true' || needs.detect-changes.outputs.infra == 'true') &&
      (needs.deploy-infrastructure.result == 'success' || needs.deploy-infrastructure.result == 'skipped')
    runs-on: ubuntu-latest
    environment: dev
    outputs:
      container_app_url: ${{ steps.deploy.outputs.container_app_url }}
      container_app_name: ${{ steps.discover.outputs.container_app_name }}
      container_registry_name: ${{ steps.discover.outputs.container_registry_name }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Discover Resource Names
        id: discover
        run: |
          echo "ðŸ” Discovering resource names..."
          
          # Discover Container Registry
          ACR_NAME=$(az acr list --resource-group ${{ env.RESOURCE_GROUP }} --query "[0].name" -o tsv)
          if [ -z "$ACR_NAME" ]; then
            echo "âŒ No Container Registry found in ${{ env.RESOURCE_GROUP }}"
            echo "   Run infrastructure deployment first!"
            exit 1
          fi
          echo "container_registry_name=$ACR_NAME" >> $GITHUB_OUTPUT
          echo "  âœ… Container Registry: $ACR_NAME"
          
          # Discover Container App Environment
          CAE_NAME=$(az containerapp env list --resource-group ${{ env.RESOURCE_GROUP }} --query "[0].name" -o tsv)
          if [ -z "$CAE_NAME" ]; then
            echo "âŒ No Container App Environment found in ${{ env.RESOURCE_GROUP }}"
            echo "   Run infrastructure deployment first!"
            exit 1
          fi
          echo "container_app_env_name=$CAE_NAME" >> $GITHUB_OUTPUT
          echo "  âœ… Container App Environment: $CAE_NAME"
          
          # Discover Container App (may not exist yet on first deploy)
          CA_NAME=$(az containerapp list --resource-group ${{ env.RESOURCE_GROUP }} --query "[0].name" -o tsv)
          if [ -z "$CA_NAME" ]; then
            echo "  â„¹ï¸ No Container App found - will create one"
            echo "container_app_exists=false" >> $GITHUB_OUTPUT
          else
            echo "container_app_name=$CA_NAME" >> $GITHUB_OUTPUT
            echo "container_app_exists=true" >> $GITHUB_OUTPUT
            echo "  âœ… Container App: $CA_NAME"
          fi

      - name: Build and Deploy Backend
        id: deploy
        run: |
          echo "ðŸ³ Building and deploying backend..."
          
          ACR_NAME="${{ steps.discover.outputs.container_registry_name }}"
          CAE_NAME="${{ steps.discover.outputs.container_app_env_name }}"
          CA_EXISTS="${{ steps.discover.outputs.container_app_exists }}"
          CA_NAME="${{ steps.discover.outputs.container_app_name }}"
          
          cd earth-copilot/container-app
          
          # Build and push image
          TIMESTAMP=$(date +%Y%m%d%H%M%S)
          IMAGE_TAG="$TIMESTAMP"
          
          az acr build \
            --registry "$ACR_NAME" \
            --image "earthcopilot-api:$IMAGE_TAG" \
            --image "earthcopilot-api:latest" \
            --file Dockerfile.complete \
            ../
          
          echo "âœ… Image built: ${ACR_NAME}.azurecr.io/earthcopilot-api:$IMAGE_TAG"
          
          # Get ACR login server
          ACR_LOGIN_SERVER=$(az acr show \
            --name "$ACR_NAME" \
            --resource-group "${{ env.RESOURCE_GROUP }}" \
            --query "loginServer" -o tsv)
          
          if [ "$CA_EXISTS" == "true" ]; then
            # Update existing Container App
            echo "ðŸ“¦ Updating existing Container App..."
            az containerapp update \
              --name "$CA_NAME" \
              --resource-group "${{ env.RESOURCE_GROUP }}" \
              --image "${ACR_LOGIN_SERVER}/earthcopilot-api:${IMAGE_TAG}" \
              --output none
          else
            # Create new Container App
            echo "ðŸ†• Creating new Container App..."
            CA_NAME="ca-earthcopilot-api"
            
            # Get AI Foundry endpoint (key may not be available if local auth is disabled)
            AZURE_OPENAI_NAME=$(az cognitiveservices account list --resource-group ${{ env.RESOURCE_GROUP }} --query "[?kind=='OpenAI'].name | [0]" -o tsv)
            AZURE_OPENAI_KEY=""
            USE_MANAGED_IDENTITY="false"
            if [ -n "$AZURE_OPENAI_NAME" ]; then
              AZURE_OPENAI_ENDPOINT=$(az cognitiveservices account show --name "$AZURE_OPENAI_NAME" --resource-group ${{ env.RESOURCE_GROUP }} --query "properties.endpoint" -o tsv)
              # Check if local auth is disabled
              LOCAL_AUTH_DISABLED=$(az cognitiveservices account show --name "$AZURE_OPENAI_NAME" --resource-group ${{ env.RESOURCE_GROUP }} --query "properties.disableLocalAuth" -o tsv)
              if [ "$LOCAL_AUTH_DISABLED" == "true" ]; then
                echo "  â„¹ï¸ Azure OpenAI has local auth disabled - will use managed identity"
                USE_MANAGED_IDENTITY="true"
              else
                AZURE_OPENAI_KEY=$(az cognitiveservices account keys list --name "$AZURE_OPENAI_NAME" --resource-group ${{ env.RESOURCE_GROUP }} --query "key1" -o tsv 2>/dev/null || echo "")
              fi
              echo "  âœ… Found Azure OpenAI: $AZURE_OPENAI_NAME"
            else
              AZURE_OPENAI_ENDPOINT=""
              echo "  âš ï¸ No Azure OpenAI found - app will use fallback settings"
            fi
            
            # Get Application Insights connection string
            APPINSIGHTS_NAME=$(az monitor app-insights component list --resource-group ${{ env.RESOURCE_GROUP }} --query "[0].name" -o tsv)
            if [ -n "$APPINSIGHTS_NAME" ]; then
              APPINSIGHTS_CS=$(az monitor app-insights component show --app "$APPINSIGHTS_NAME" --resource-group ${{ env.RESOURCE_GROUP }} --query "connectionString" -o tsv)
              echo "  âœ… Found Application Insights: $APPINSIGHTS_NAME"
            else
              APPINSIGHTS_CS=""
            fi
            
            # Create Container App with managed identity
            az containerapp create \
              --name "$CA_NAME" \
              --resource-group "${{ env.RESOURCE_GROUP }}" \
              --environment "$CAE_NAME" \
              --image "${ACR_LOGIN_SERVER}/earthcopilot-api:${IMAGE_TAG}" \
              --target-port 8080 \
              --ingress external \
              --cpu 1.0 \
              --memory 2.0Gi \
              --min-replicas 1 \
              --max-replicas 3 \
              --system-assigned \
              --env-vars \
                "PORT=8080" \
                "STAC_API_URL=https://planetarycomputer.microsoft.com/api/stac/v1" \
                "CORS_ORIGINS=*" \
                "AZURE_OPENAI_ENDPOINT=${AZURE_OPENAI_ENDPOINT}" \
                "AZURE_OPENAI_API_KEY=${AZURE_OPENAI_KEY}" \
                "USE_MANAGED_IDENTITY=${USE_MANAGED_IDENTITY}" \
                "APPLICATION_INSIGHTS_CONNECTION_STRING=${APPINSIGHTS_CS}" \
              --output none
            
            echo "âœ… Container App created: $CA_NAME"
            
            # If using managed identity for Azure OpenAI, grant Cognitive Services User role
            if [ "$USE_MANAGED_IDENTITY" == "true" ] && [ -n "$AZURE_OPENAI_NAME" ]; then
              echo "ðŸ” Configuring managed identity for Azure OpenAI..."
              CA_IDENTITY=$(az containerapp show --name "$CA_NAME" --resource-group ${{ env.RESOURCE_GROUP }} --query "identity.principalId" -o tsv)
              OPENAI_ID=$(az cognitiveservices account show --name "$AZURE_OPENAI_NAME" --resource-group ${{ env.RESOURCE_GROUP }} --query "id" -o tsv)
              
              az role assignment create \
                --assignee "$CA_IDENTITY" \
                --role "Cognitive Services OpenAI User" \
                --scope "$OPENAI_ID" \
                --output none 2>/dev/null || true
              
              echo "âœ… Managed identity configured for Azure OpenAI"
            fi
            
            # Configure ACR pull with managed identity
            echo "ðŸ” Configuring managed identity for ACR pull..."
            CA_IDENTITY=$(az containerapp show --name "$CA_NAME" --resource-group ${{ env.RESOURCE_GROUP }} --query "identity.principalId" -o tsv)
            ACR_ID=$(az acr show --name "$ACR_NAME" --resource-group ${{ env.RESOURCE_GROUP }} --query "id" -o tsv)
            
            # Grant AcrPull role to the Container App's managed identity
            az role assignment create \
              --assignee "$CA_IDENTITY" \
              --role "AcrPull" \
              --scope "$ACR_ID" \
              --output none 2>/dev/null || true
            
            # Update Container App to use managed identity for registry
            az containerapp registry set \
              --name "$CA_NAME" \
              --resource-group "${{ env.RESOURCE_GROUP }}" \
              --server "$ACR_LOGIN_SERVER" \
              --identity system \
              --output none
            
            echo "âœ… Managed identity configured for ACR pull"
          fi
          
          echo "container_app_name=$CA_NAME" >> $GITHUB_OUTPUT
          
          # Get URL
          CONTAINER_APP_URL=$(az containerapp show \
            --name "$CA_NAME" \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --query "properties.configuration.ingress.fqdn" -o tsv)
          
          echo "container_app_url=https://$CONTAINER_APP_URL" >> $GITHUB_OUTPUT
          echo "âœ… Backend deployed to: https://$CONTAINER_APP_URL"

  # Deploy Frontend (if frontend files changed, runs after backend)
  deploy-frontend:
    name: Deploy Frontend
    needs: [detect-changes, deploy-infrastructure, deploy-backend]
    if: |
      always() &&
      (needs.detect-changes.outputs.frontend == 'true' || needs.detect-changes.outputs.infra == 'true') &&
      (needs.deploy-infrastructure.result == 'success' || needs.deploy-infrastructure.result == 'skipped') &&
      (needs.deploy-backend.result == 'success' || needs.deploy-backend.result == 'skipped')
    runs-on: ubuntu-latest
    environment: dev
    outputs:
      web_app_name: ${{ steps.discover.outputs.web_app_name }}
      web_app_url: ${{ steps.deploy.outputs.web_app_url }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: earth-copilot/web-ui/package-lock.json

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Discover Resource Names
        id: discover
        run: |
          echo "ðŸ” Discovering resource names..."
          
          # Discover Container App
          CA_NAME=$(az containerapp list --resource-group ${{ env.RESOURCE_GROUP }} --query "[0].name" -o tsv)
          if [ -z "$CA_NAME" ]; then
            echo "âŒ No Container App found in ${{ env.RESOURCE_GROUP }}"
            exit 1
          fi
          echo "container_app_name=$CA_NAME" >> $GITHUB_OUTPUT
          echo "  âœ… Container App: $CA_NAME"
          
          # Discover or create Web App
          WA_NAME=$(az webapp list --resource-group ${{ env.RESOURCE_GROUP }} --query "[0].name" -o tsv)
          if [ -z "$WA_NAME" ]; then
            echo "  â„¹ï¸ No Web App found - will create one"
            echo "web_app_exists=false" >> $GITHUB_OUTPUT
            WA_NAME="app-earthcopilot-ui"
          else
            echo "web_app_exists=true" >> $GITHUB_OUTPUT
            echo "  âœ… Web App: $WA_NAME"
          fi
          echo "web_app_name=$WA_NAME" >> $GITHUB_OUTPUT

      - name: Get Backend URL
        id: get-backend-url
        run: |
          CA_NAME="${{ steps.discover.outputs.container_app_name }}"
          CONTAINER_APP_URL=$(az containerapp show \
            --name "$CA_NAME" \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --query "properties.configuration.ingress.fqdn" -o tsv)
          echo "backend_url=https://$CONTAINER_APP_URL" >> $GITHUB_OUTPUT
          echo "  âœ… Backend URL: https://$CONTAINER_APP_URL"

      - name: Get Azure Maps Key
        id: get-maps-key
        run: |
          # Find Azure Maps account in resource group
          MAPS_ACCOUNT=$(az maps account list \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --query "[0].name" -o tsv)
          
          if [ -n "$MAPS_ACCOUNT" ]; then
            MAPS_KEY=$(az maps account keys list \
              --name "$MAPS_ACCOUNT" \
              --resource-group ${{ env.RESOURCE_GROUP }} \
              --query "primaryKey" -o tsv)
            echo "maps_key=$MAPS_KEY" >> $GITHUB_OUTPUT
            echo "âœ… Azure Maps key retrieved from: $MAPS_ACCOUNT"
          else
            echo "âš ï¸ No Azure Maps account found in ${{ env.RESOURCE_GROUP }}"
            echo "maps_key=" >> $GITHUB_OUTPUT
          fi

      - name: Build and Deploy Frontend
        id: deploy
        run: |
          echo "ðŸŽ¨ Building and deploying frontend..."
          
          WA_NAME="${{ steps.discover.outputs.web_app_name }}"
          WA_EXISTS="${{ steps.discover.outputs.web_app_exists }}"
          
          # Create Web App if it doesn't exist
          if [ "$WA_EXISTS" != "true" ]; then
            echo "ðŸ†• Creating new Web App..."
            
            # Create App Service Plan
            ASP_NAME="asp-earthcopilot"
            az appservice plan create \
              --name "$ASP_NAME" \
              --resource-group "${{ env.RESOURCE_GROUP }}" \
              --location "${{ env.LOCATION }}" \
              --sku B1 \
              --is-linux \
              --output none
            
            echo "  âœ… Created App Service Plan: $ASP_NAME"
            
            # Create Web App
            az webapp create \
              --name "$WA_NAME" \
              --resource-group "${{ env.RESOURCE_GROUP }}" \
              --plan "$ASP_NAME" \
              --runtime "NODE:20-lts" \
              --output none
            
            echo "  âœ… Created Web App: $WA_NAME"
            
            # Configure Web App
            az webapp config appsettings set \
              --name "$WA_NAME" \
              --resource-group "${{ env.RESOURCE_GROUP }}" \
              --settings \
                SCM_DO_BUILD_DURING_DEPLOYMENT=false \
                WEBSITE_NODE_DEFAULT_VERSION=~20 \
                VITE_API_BASE_URL="${{ steps.get-backend-url.outputs.backend_url }}" \
                PORT=8080 \
              --output none
            
            echo "  âœ… Configured Web App settings"
          fi
          
          cd earth-copilot/web-ui
          
          # Install and build with environment variables
          npm ci
          VITE_API_BASE_URL="${{ steps.get-backend-url.outputs.backend_url }}" \
          VITE_AZURE_MAPS_SUBSCRIPTION_KEY="${{ steps.get-maps-key.outputs.maps_key }}" \
          npm run build
          
          # Create server for App Service
          cat > dist/server.js << 'EOF'
          const express = require('express');
          const path = require('path');
          const app = express();
          const port = process.env.PORT || 8080;
          app.use(express.static(__dirname));
          app.get('*', (req, res) => res.sendFile(path.join(__dirname, 'index.html')));
          app.listen(port, () => console.log('Server running on port ' + port));
          EOF
          
          cat > dist/package.json << 'EOF'
          {"name":"earth-copilot-ui","version":"1.0.0","main":"server.js","scripts":{"start":"node server.js"},"dependencies":{"express":"^4.18.0"}}
          EOF
          
          cd dist
          npm install --production
          zip -r ../deploy.zip .
          cd ..
          
          # Deploy to App Service
          az webapp deploy \
            --resource-group "${{ env.RESOURCE_GROUP }}" \
            --name "$WA_NAME" \
            --src-path deploy.zip \
            --type zip
          
          WEB_URL=$(az webapp show \
            --resource-group "${{ env.RESOURCE_GROUP }}" \
            --name "$WA_NAME" \
            --query "defaultHostName" -o tsv)
          
          echo "web_app_url=https://$WEB_URL" >> $GITHUB_OUTPUT
          echo "âœ… Frontend deployed to: https://$WEB_URL"

  # Summary
  summary:
    name: Deployment Summary
    needs: [detect-changes, deploy-infrastructure, deploy-backend, deploy-frontend]
    if: always()
    runs-on: ubuntu-latest
    environment: dev
    steps:
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Generate Summary
        run: |
          echo "# ðŸš€ Earth Copilot Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## ðŸ“Š Components Deployed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "| Component | Changed | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|---------|--------|" >> $GITHUB_STEP_SUMMARY
          
          # Infrastructure
          if [ "${{ needs.detect-changes.outputs.infra }}" == "true" ]; then
            if [ "${{ needs.deploy-infrastructure.result }}" == "success" ]; then
              echo "| Infrastructure | âœ… Yes | âœ… Deployed |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| Infrastructure | âœ… Yes | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "| Infrastructure | â­ï¸ No | â­ï¸ Skipped |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Backend
          if [ "${{ needs.detect-changes.outputs.backend }}" == "true" ] || [ "${{ needs.detect-changes.outputs.infra }}" == "true" ]; then
            if [ "${{ needs.deploy-backend.result }}" == "success" ]; then
              echo "| Backend | âœ… Yes | âœ… Deployed |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| Backend | âœ… Yes | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "| Backend | â­ï¸ No | â­ï¸ Skipped |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Frontend
          if [ "${{ needs.detect-changes.outputs.frontend }}" == "true" ] || [ "${{ needs.detect-changes.outputs.infra }}" == "true" ]; then
            if [ "${{ needs.deploy-frontend.result }}" == "success" ]; then
              echo "| Frontend | âœ… Yes | âœ… Deployed |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| Frontend | âœ… Yes | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "| Frontend | â­ï¸ No | â­ï¸ Skipped |" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸŒ Endpoints" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Discover actual resource names and URLs
          WA_NAME=$(az webapp list --resource-group ${{ env.RESOURCE_GROUP }} --query "[0].name" -o tsv 2>/dev/null || echo "")
          CA_NAME=$(az containerapp list --resource-group ${{ env.RESOURCE_GROUP }} --query "[0].name" -o tsv 2>/dev/null || echo "")
          
          if [ -n "$WA_NAME" ]; then
            WEB_URL=$(az webapp show --resource-group ${{ env.RESOURCE_GROUP }} --name "$WA_NAME" --query "defaultHostName" -o tsv)
            echo "- **Frontend**: https://$WEB_URL" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Frontend**: âš ï¸ Not deployed yet" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -n "$CA_NAME" ]; then
            CA_URL=$(az containerapp show --resource-group ${{ env.RESOURCE_GROUP }} --name "$CA_NAME" --query "properties.configuration.ingress.fqdn" -o tsv)
            echo "- **Backend API**: https://$CA_URL" >> $GITHUB_STEP_SUMMARY
            echo "- **API Docs**: https://$CA_URL/docs" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Backend**: âš ï¸ Not deployed yet" >> $GITHUB_STEP_SUMMARY
          fi
